<scaffold>
    <refresh onRefresh="onRefresh" loading="$loading">
        <slivers>
            <sliver-appbar expandedHeight="288"
                        color="white" 
                        floating="true" 
                        pinned="true">
                <FlexibleSpaceBar padding="ltrb(20,0,0,64)">
                    <attr:background>
                        <stack>
                            <img src="$picture" fit="cover" width="infinity()" height="infinity()"/>
                            <filter filter="blur(4, 4)">
                                <view color="hex(#0000)"/>
                            </filter>
                            <view width="infinity()" height="infinity()" >
                                <attr:gradient>
                                    <LinearGradient begin="topCenter" end="bottomCenter">
                                        <attr:colors>
                                            <color>hex(#0007)</color>
                                            <color>hex(#0000)</color>
                                            <color>hex(#0007)</color>
                                        </attr:colors>
                                    </LinearGradient>
                                </attr:gradient>
                            </view>
                        </stack>
                    </attr:background>
                    <text lines="4" overflow="ellipsis">
                        <span size="14">$title</span>
                        <span alignment="middle">
                            <button type="text" 
                                    tapTargetSize="shrinkWrap" 
                                    minimumSize="zero"
                                    padding="ltrb(4,1,4,10)" 
                                    onPressed="onSourcePressed">
                                <text size="6" text="loc('source')"/>
                            </button>
                        </span>
                        <if candidate="isNotNull($subtitle)"> 
                            <span>
                                <view padding="ltrb(0,5,0,0)"/>
                            </span>
                            <span size="8">$subtitle</span>
                        </if>
                        <if candidate="isNotNull($summary)"> 
                            <span>
                                <view padding="ltrb(0,5,0,0)"/>
                            </span>
                            <span size="8">$summary</span>
                        </if>
                    </text>
                </FlexibleSpaceBar>
                <attr:actions>
                    <button type="icon" onPressed="onFavoritePressed">
                        <icon>favorite</icon>
                    </button>
                </attr:actions>
                <attr:bottom>
                    <PreferredSize size="(infinity(), 48)">
                        <view color="color(canvas)" height="48" padding="ltrb(10,0,10,0)">
                            <row>
                                <icon color="color(primary)">bookmark</icon>
                                <text text="loc(chapters)"/>
                                <expanded />
                                <menu-button>
                                    <attr:icon>
                                        <icon color="color(primary)">sort</icon>
                                    </attr:icon>
                                    <attr:items>
                                        <menu-item>
                                            <text text="loc(reverse_order)"/>
                                        </menu-item>
                                        <menu-item>
                                            <text text="loc(order)"/>
                                        </menu-item>
                                    </attr:items>
                                </menu-button>
                                <divider type="vertical"/>
                                <switch axis="horizontal">
                                    <if candidate="$editing">
                                        <button id="clear-button" padding="ltrb(8,13,8,8)" type="icon" color="color(primary)" onPressed="onClearPressed">
                                            <icon>clear</icon>
                                        </button>
                                    </if>
                                    <else> <view/> </else>
                                </switch>
                                <switch axis="horizontal">
                                    <if candidate="$editing">
                                        <button id="check-button" padding="ltrb(8,13,8,8)" type="icon" color="color(primary)" onPressed="onCheckPressed">
                                            <icon>check</icon>
                                        </button>
                                    </if>
                                    <else> <view/> </else>
                                </switch>
                                <switch axis="horizontal">
                                    <if candidate="not($editing)">
                                        <button id="download-button" padding="ltrb(8,13,8,8)" type="icon" color="color(primary)" onPressed="onDownloadPressed">
                                            <icon>file_download</icon>
                                        </button>
                                    </if>
                                    <else> <view/> </else>
                                </switch>
                            </row>
                        </view>
                    </PreferredSize>
                </attr:bottom>
            </sliver-appbar>
            <sliver-list-view itemCount="length(${list})">
                <attr:builder>
                    <Function returnType='Widget'>
                        <script>
                            set("item", ${list[args[1]]})
                        </script>
                        <list-item>
                            <attr:onTap>
                                <callback function="onPressed" args="array(${args[1]})"/>
                            </attr:onTap>
                            <attr:title>
                                <text>${item.title}</text>
                            </attr:title>
                            <if candidate="isNotNull(${item.subtitle})">
                                <attr:subtitle>
                                    <text>${item.subtitle}</text>
                                </attr:subtitle>
                            </if>
                        </list-item>
                    </Function>
                </attr:builder>
            </sliver-list-view>
        </slivers>
    </refresh>
</scaffold>